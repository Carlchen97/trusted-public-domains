name: Issue to Allowlist PR

on:
  issues:
    types: [opened, edited, reopened, labeled]

jobs:
  create-pr:
    if: contains(github.event.issue.labels.*.name, 'allowlist')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
    steps:
      - uses: actions/checkout@v4

      - name: Extract candidate domain
        id: extract
        run: |
          TITLE=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
          BODY=$(jq -r '.issue.body'  "$GITHUB_EVENT_PATH")

          # Prefer title like "allow: example.gov"
          DOMAIN_FROM_TITLE=$(printf "%s" "$TITLE" \
            | tr 'A-Z' 'a-z' \
            | sed -E 's/^allow:\s*//' \
            | grep -Eo '([a-z0-9-]+\.)+[a-z]{2,63}' \
            | head -n1)

          if [ -n "$DOMAIN_FROM_TITLE" ]; then
            CANDIDATE="$DOMAIN_FROM_TITLE"
          else
            # Try Issue Forms "Domain" section or any domain in body
            CANDIDATE=$(printf "%s" "$BODY" \
              | tr 'A-Z' 'a-z' \
              | grep -Eo '([a-z0-9-]+\.)+[a-z]{2,63}' \
              | head -n1)
          fi

          echo "candidate=$CANDIDATE" >> "$GITHUB_OUTPUT"

      - name: Validate domain syntax (ASCII FQDN)
        id: validate
        run: |
          D="${{ steps.extract.outputs.candidate }}"
          D=$(printf "%s" "$D" | tr -d '[:space:]')
          if [ -z "$D" ]; then
            echo "No domain found in title/body."
            exit 1
          fi
          if ! printf "%s" "$D" | grep -Eq '^[a-z0-9-]+(\.[a-z0-9-]+)+$'; then
            echo "Invalid domain syntax: '$D'"
            exit 1
          fi
          echo "domain=$D" >> "$GITHUB_OUTPUT"

      - name: Create branch
        run: |
          BR="allow/${{ steps.validate.outputs.domain }}"
          git checkout -b "$BR"

      - name: Append to data/domains.txt (sorted & deduped)
        run: |
          mkdir -p data
          touch data/domains.txt
          printf "%s\n" "${{ steps.validate.outputs.domain }}" >> data/domains.txt
          # Keep ASCII-only, lowercase, unique, sorted
          grep -E '^[A-Za-z0-9.-]+$' data/domains.txt \
            | sed '/^$/d' \
            | tr 'A-Z' 'a-z' \
            | sort -u > data/.tmp && mv data/.tmp data/domains.txt
          git add data/domains.txt
          git -c user.name="github-actions[bot]" -c user.email="41898282+github-actions[bot]@users.noreply.github.com" \
            commit -m "allow: ${{ steps.validate.outputs.domain }}"

      - name: Open pull request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "allow: ${{ steps.validate.outputs.domain }}"
          title: "Add to allowlist: ${{ steps.validate.outputs.domain }}"
          body: |
            Auto-generated PR from Issue #${{ github.event.issue.number }}.
            Domain: `${{ steps.validate.outputs.domain }}`
          branch: "allow/${{ steps.validate.outputs.domain }}"
          labels: allowlist
