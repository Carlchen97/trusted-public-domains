<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Trusted Public Domains – Submit Domains</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-gray-50 text-gray-900">
    <main class="max-w-2xl mx-auto p-6 space-y-6">
      <header>
        <h1 class="text-3xl font-bold">Submit trusted public domains</h1>
        <p class="text-sm text-gray-600 mt-2">
          Government or public institution only. Examples: <code>example.gov</code>, <code>who.int</code>, <code>gov.uk</code>.
        </p>
      </header>

      <form id="domainForm" class="space-y-5 rounded-2xl bg-white p-5 shadow">
        <!-- Single domain (optional) -->
        <div>
          <label for="domain" class="block text-sm font-medium">Single domain (optional)</label>
          <input id="domain" type="text"
                 class="mt-1 w-full rounded-xl border px-3 py-2 outline-none focus:ring"
                 placeholder="example.gov" />
          <p class="mt-1 text-xs text-gray-500">
            ASCII/punycode only. No URLs or IPs. Subdomains allowed.
          </p>
        </div>

        <!-- Bulk textarea (optional) -->
        <div>
          <label for="domainsTextarea" class="block text-sm font-medium">Bulk paste (optional)</label>
          <textarea id="domainsTextarea" rows="5"
                    class="mt-1 w-full rounded-xl border px-3 py-2 outline-none focus:ring"
                    placeholder="one.domain\nper.line"></textarea>
          <p class="mt-1 text-xs text-gray-500">
            One domain per line. Will be merged with file upload and single domain.
          </p>
        </div>

        <!-- TXT file upload -->
        <div>
          <label for="file" class="block text-sm font-medium">TXT file upload (optional)</label>
          <input id="file" type="file" accept=".txt"
                 class="mt-1 w-full rounded-xl border px-3 py-2" />
          <p class="mt-1 text-xs text-gray-500">
            Plain text (.txt), one domain per line.
          </p>
        </div>

        <!-- Reason -->
        <div>
          <label for="reason" class="block text-sm font-medium">Why are these trustworthy? (optional)</label>
          <textarea id="reason" rows="4"
                    class="mt-1 w-full rounded-xl border px-3 py-2 outline-none focus:ring"
                    placeholder="Official portals of …"></textarea>
        </div>

        <!-- Preview -->
        <div class="rounded-xl bg-gray-50 border px-3 py-3">
          <p class="text-sm">
            <span class="font-semibold">Preview:</span>
            <span id="count" class="font-mono">0</span> domains will be submitted.
          </p>
          <div id="preview" class="mt-2 text-xs max-h-40 overflow-auto font-mono"></div>
        </div>

        <button type="submit"
                class="rounded-xl bg-black px-4 py-2 font-semibold text-white hover:opacity-90">
          Open prefilled GitHub issue
        </button>

        <p class="text-xs text-gray-500">
          You’ll be redirected to GitHub to submit an Issue. You must be logged in.
        </p>
      </form>
    </main>

    <script>
      // ---- CONFIG: your repo (set and ready) ----
      const OWNER = "Carlchen97";
      const REPO  = "trusted-public-domains";

      // Simple ASCII FQDN: labels [a-z0-9-], at least one dot, TLD 2–63 alpha chars
      const reDomain = /^[a-z0-9-]+(\.[a-z0-9-]+)+$/;

      function extractDomains(text) {
        return (text || "")
          .split(/\r?\n|[,\s]+/g)
          .map(s => s.trim().toLowerCase())
          .filter(Boolean)
          .map(s => s.replace(/^https?:\/\//, "").replace(/\/.*$/, "")) // strip URL scheme & path if pasted
          .filter(s => reDomain.test(s));
      }

      async function readFileText(file) {
        if (!file) return "";
        return await new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => resolve(String(r.result || ""));
          r.onerror = () => reject(r.error);
          r.readAsText(file);
        });
      }

      async function gatherDomains() {
        const single = document.getElementById("domain").value;
        const bulkText = document.getElementById("domainsTextarea").value;
        const file = document.getElementById("file").files[0];

        const fromSingle = extractDomains(single);
        const fromBulk = extractDomains(bulkText);
        const fromFile = extractDomains(await readFileText(file));

        // unique + sorted
        const all = Array.from(new Set([...fromSingle, ...fromBulk, ...fromFile])).sort();
        return all;
      }

      async function refreshPreview() {
        const domains = await gatherDomains();
        document.getElementById("count").textContent = domains.length;
        document.getElementById("preview").textContent = domains.slice(0, 200).join("\n");
      }

      ["domain","domainsTextarea","file"].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener("input", refreshPreview);
        el.addEventListener("change", refreshPreview);
      });
      refreshPreview();

      document.getElementById("domainForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const domains = await gatherDomains();
        const reason = document.getElementById("reason").value.trim();

        if (domains.length === 0) {
          alert("Please provide at least one valid ASCII domain.");
          return;
        }

        const isBulk = domains.length > 1;
        const title = isBulk
          ? `allow: bulk (${domains.length})`
          : `allow: ${domains[0]}`;

        const body =
`Domains:
\`\`\`
${domains.join("\n")}
\`\`\`

Reason:
${reason || "(not provided)"}

_This issue was created via the web form. A bot will open a PR if validation passes._`;

        const url = new URL(`https://github.com/${OWNER}/${REPO}/issues/new`);
        url.searchParams.set("title", title);
        url.searchParams.set("body", body);
        window.location.href = url.toString();
      });
    </script>
  </body>
</html>
