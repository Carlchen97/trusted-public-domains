name: Issue to Allowlist PR

on:
  issues:
    types: [opened, edited, reopened, labeled]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  create-pr:
    # Only proceed when the title begins with "allow:" (case-insensitive)
    if: startsWith(github.event.issue.title, 'allow:') || startsWith(github.event.issue.title, 'ALLOW:')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
    steps:
      - uses: actions/checkout@v4

      - name: Extract domains from issue
        id: extract
        run: |
          TITLE=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
          BODY=$(jq -r '.issue.body'  "$GITHUB_EVENT_PATH")

          # 1) Try the code block after "Domains:" (web form bulk path)
          DOMAINS=$(printf "%s\n" "$BODY" \
            | awk '/^Domains:/,/^$/ {print}' \
            | sed -n '/^```/,$p' \
            | sed '1d;$d' 2>/dev/null \
            | tr 'A-Z' 'a-z')

          # 2) Fallback: pick any FQDNs from title/body
          if [ -z "$DOMAINS" ]; then
            DOMAINS=$(printf "%s\n%s\n" "$TITLE" "$BODY" \
              | tr 'A-Z' 'a-z' \
              | sed -E 's#https?://##g; s#/[^ ]*##g' \
              | grep -Eo '([a-z0-9-]+\.)+[a-z]{2,63}')
          fi

          # normalize, ASCII-only, dedupe, sort
          printf "%s\n" "$DOMAINS" \
            | tr -d '[:space:]' \
            | grep -E '^[a-z0-9.-]+$' \
            | sed '/^$/d' \
            | sort -u > domains.txt

          COUNT=$(wc -l < domains.txt | tr -d '[:space:]')

          if [ "$COUNT" -eq 0 ]; then
            echo "No valid domains found."
            cat domains.txt || true
            exit 1
          fi

          echo "count=$COUNT" >> "$GITHUB_OUTPUT"
          echo "Extracted domains:"
          cat domains.txt

      - name: Update data/domains.txt (no commit here)
        run: |
          mkdir -p data
          touch data/domains.txt
          cat domains.txt >> data/domains.txt
          # normalize + dedupe
          grep -E '^[A-Za-z0-9.-]+$' data/domains.txt \
            | sed '/^$/d' \
            | tr 'A-Z' 'a-z' \
            | sort -u > data/.tmp && mv data/.tmp data/domains.txt

      - name: Open pull request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "allow: ${{ steps.extract.outputs.count }} domain(s)"
          title: "Add to allowlist: ${{ steps.extract.outputs.count }} domain(s)"
          body: |
            Auto-generated PR from Issue #${{ github.event.issue.number }}.

            Domains added (count=${{ steps.extract.outputs.count }}):
            ```
            ${{ steps.extract.outputs.count && '' }}
            ```
            Closes #${{ github.event.issue.number }}
          branch: "allow/bulk-${{ github.event.issue.number }}"
          add-paths: |
            data/domains.txt
